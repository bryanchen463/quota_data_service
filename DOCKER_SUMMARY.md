# Docker 部署文件总结

## 已创建的文件

### 1. 核心配置文件

- **`Dockerfile`** - 多阶段构建的Docker镜像
  - 构建阶段：安装protobuf编译器、生成代码、编译Go程序
  - 运行阶段：轻量级Debian镜像、非root用户、健康检查

- **`docker-compose.yml`** - 完整的服务编排配置
  - 行情数据服务（HTTP + gRPC）
  - ClickHouse数据库
  - 可选调试和测试服务
  - 网络配置和资源限制

### 2. 配置文件

- **`clickhouse-config/01-crypto-market.xml`** - ClickHouse配置
  - 数据库和用户设置
  - 性能优化参数
  - 权限管理

- **`env.example`** - 环境变量示例
  - 服务端口配置
  - 数据库连接参数
  - 批处理调优参数

### 3. 管理脚本

- **`start.sh`** - 服务管理脚本
  - 启动/停止/重启服务
  - 查看状态和日志
  - 健康检查
  - 资源清理

- **`.dockerignore`** - Docker构建优化
  - 排除不必要的文件
  - 减少构建上下文大小
  - 提高构建效率

### 4. 文档

- **`DOCKER_README.md`** - 详细使用说明
- **`DOCKER_SUMMARY.md`** - 本总结文档

## 技术特性

### 多阶段构建
- 构建阶段：完整的Go开发环境
- 运行阶段：轻量级生产镜像
- 自动protobuf代码生成

### 服务编排
- 自动依赖管理
- 健康检查集成
- 资源限制配置
- 数据持久化

### 网络配置
- 自定义网络子网
- 服务间通信隔离
- 端口映射管理

### 监控和调试
- 内置健康检查
- 日志收集
- 调试工具集成
- 性能监控

## 部署架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   外部客户端    │    │   外部客户端    │    │   外部客户端    │
│   (HTTP/gRPC)   │    │   (HTTP/gRPC)   │    │   (HTTP/gRPC)   │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
                    ┌─────────────┴─────────────┐
                    │      Docker Network       │
                    │   (172.20.0.0/16)        │
                    └─────────────┬─────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │    quota-data-service     │
                    │   (HTTP:8080, gRPC:9090) │
                    └─────────────┬─────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │      ClickHouse           │
                    │   (TCP:9000, HTTP:8123)  │
                    └───────────────────────────┘
```

## 端口配置

| 服务 | 容器端口 | 主机端口 | 协议 | 用途 |
|------|----------|----------|------|------|
| 行情数据服务 | 8080 | 8080 | HTTP | HTTP API |
| 行情数据服务 | 9090 | 9090 | gRPC | gRPC API |
| ClickHouse | 9000 | 9000 | TCP | Native协议 |
| ClickHouse | 8123 | 8123 | HTTP | HTTP接口 |
| ClickHouse | 9009 | 9009 | TCP | 集群通信 |

## 使用方法

### 快速启动
```bash
# 启动所有服务
./start.sh start

# 查看状态
./start.sh status

# 查看日志
./start.sh logs
```

### 手动管理
```bash
# 启动服务
docker-compose up -d

# 停止服务
docker-compose down

# 重新构建
docker-compose build --no-cache
```

### 调试模式
```bash
# 启动调试服务
docker-compose --profile debug up -d

# 连接到ClickHouse客户端
docker-compose exec clickhouse-client clickhouse-client --host clickhouse --port 9000
```

### 测试模式
```bash
# 启动测试服务
docker-compose --profile test up -d

# 查看测试结果
docker-compose logs grpc-test-client
```

## 性能优化

### 资源限制
- 行情数据服务：内存1G，CPU 1核
- ClickHouse：内存2G，CPU 2核
- 可根据实际需求调整

### 批处理参数
- 冲刷间隔：10ms（可调）
- 最大批量：800条（可调）
- 队列容量：20000条（可调）

### ClickHouse优化
- 内存使用限制：10GB
- 外部排序阈值：20GB
- 外部分组阈值：20GB

## 安全考虑

### 用户权限
- 非root用户运行
- 最小权限原则
- 网络访问控制

### 数据保护
- 数据持久化
- 备份策略
- 访问日志

### 网络安全
- 自定义网络隔离
- 端口限制
- 服务间通信控制

## 监控和维护

### 健康检查
- HTTP端点：`/healthz`
- 自动重启策略
- 状态监控

### 日志管理
- 结构化日志
- 日志轮转
- 错误追踪

### 备份策略
- 数据卷备份
- 配置备份
- 恢复流程

## 扩展性

### 水平扩展
- 无状态服务设计
- 负载均衡支持
- 自动扩缩容

### 集群部署
- ClickHouse集群
- 服务发现
- 配置管理

### 微服务架构
- 服务解耦
- API网关
- 监控集成

## 总结

我们已经创建了完整的Docker部署方案，包括：

✅ **容器化应用** - 多阶段构建，优化镜像大小
✅ **服务编排** - 完整的docker-compose配置
✅ **配置管理** - 环境变量和配置文件
✅ **监控调试** - 健康检查和日志管理
✅ **自动化脚本** - 一键启动和管理
✅ **文档说明** - 详细的使用指南

这个部署方案提供了：
- 开发环境的快速搭建
- 生产环境的稳定部署
- 灵活的配置管理
- 完整的监控体系
- 易于维护和扩展

建议在生产环境中：
1. 配置适当的资源限制
2. 设置定期备份
3. 集成监控系统
4. 配置日志轮转
5. 使用私有镜像仓库 